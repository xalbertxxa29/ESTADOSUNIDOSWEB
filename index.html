<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reportes Liderman</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK v8 (Compatible con tu c√≥digo) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Chart.js Data Labels Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- XLSX for Excel export - VERSI√ìN COMPLETA Y FUNCIONAL -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Garantizar XLSX disponible globalmente con espera -->
    <script>
        let xlsxReady = false;
        const waitForXLSX = () => {
            if (typeof XLSX !== 'undefined' && XLSX.utils && XLSX.writeFile) {
                window.XLSX = XLSX;
                xlsxReady = true;
                console.log('‚úÖ XLSX cargado completamente y disponible globalmente');
                console.log('‚úÖ XLSX.utils:', XLSX.utils);
            } else {
                setTimeout(waitForXLSX, 100);
            }
        };
        waitForXLSX();
    </script>
    
    <!-- HTML2PDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Library Initialization Check -->
    <script>
        // Verificar que las librer√≠as est√©n disponibles
        window.addEventListener('load', () => {
            console.log('üîç Verificando librer√≠as cargadas...');
            console.log('‚úÖ XLSX:', typeof XLSX !== 'undefined' ? 'Cargado' : 'NO CARGADO');
            console.log('‚úÖ html2pdf:', typeof html2pdf !== 'undefined' ? 'Cargado' : 'NO CARGADO');
            console.log('‚úÖ Chart:', typeof Chart !== 'undefined' ? 'Cargado' : 'NO CARGADO');
            console.log('‚úÖ firebase:', typeof firebase !== 'undefined' ? 'Cargado' : 'NO CARGADO');
            console.log('‚úÖ L (Leaflet):', typeof L !== 'undefined' ? 'Cargado' : 'NO CARGADO');
        });
    </script>
    
    <!-- Leaflet for Maps - Corrected URLs from unpkg -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Languages Configuration -->
    <script src="languages.js"></script>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="loginContainer" class="login-container">
        <div class="login-wrapper">
            <!-- Selector de idioma en login -->
            <div class="language-selector-login">
                <select id="languageSelectorLogin" class="lang-select">
                    <option value="es">Espa√±ol</option>
                    <option value="en">English</option>
                </select>
            </div>

            <div class="login-card">
                <div class="login-header">
                    <h1 class="login-title">
                        <span data-i18n="sistema_de_reportes">Sistema de Reportes</span> Liderman
                    </h1>
                    <p class="login-subtitle" data-i18n="login_subtitle">Reportes e Incidencias</p>
                </div>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="email" data-i18n="email_label">Correo Electr√≥nico</label>
                        <div class="input-wrapper">
                            <i class="fas fa-envelope"></i>
                            <input 
                                type="email" 
                                id="email" 
                                data-i18n-placeholder="email_placeholder"
                                placeholder="@liderman.com.pe" 
                                required
                            >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="password" data-i18n="password_label">Contrase√±a</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock"></i>
                            <input 
                                type="password" 
                                id="password" 
                                data-i18n-placeholder="password_placeholder"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                required
                            >
                        </div>
                    </div>

                    <button type="submit" class="btn-login">
                        <span data-i18n="login_button">Iniciar Sesi√≥n</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </form>

                <div id="loginError" class="login-error"></div>
                <div id="loginLoader" class="login-loader"></div>
            </div>

            <div class="login-background">
                <div class="blob blob-1"></div>
                <div class="blob blob-2"></div>
                <div class="blob blob-3"></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- SIDEBAR NAVIGATION -->
        <aside class="sidebar">
            <div class="sidebar-header" style="display: flex; flex-direction: column; align-items: center; gap: 10px; padding-bottom: 10px;">
                <img src="logo.png" alt="Logo" style="height: 48px; width: 48px; border-radius: 12px; box-shadow: 0 2px 8px rgba(220,38,38,0.15); background: #fff; margin-bottom: 4px;">
                <h2 class="sidebar-title" style="color: #fff; font-weight: 800; font-size: 22px; letter-spacing: 1px;">
                    <span data-i18n="sistema_de_reportes">Sistema de Reportes</span> Liderman
                </h2>
                <button class="btn-hamburger" id="toggleSidebar" style="margin-top: 6px; background: #fff; border: 2px solid #dc2626; border-radius: 8px; padding: 6px 12px; color: #dc2626; font-size: 20px; cursor: pointer; box-shadow: 0 2px 8px rgba(220,38,38,0.10);">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" data-page="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span data-i18n="dashboard_menu">Dashboard</span>
                </a>
                <a href="#" class="menu-item" data-page="table">
                    <i class="fas fa-table"></i>
                    <span data-i18n="table_menu">Tabla</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="logout_button">Cerrar Sesi√≥n</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- HEADER -->
            <header class="top-header">
                <div class="header-left">
                    <button class="btn-hamburger-header" id="toggleSidebarHeader">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 id="pageTitle">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="language-selector">
                        <select id="languageSelector" class="lang-select">
                            <option value="es">Espa√±ol</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="user-profile">
                        <span id="userEmail"></span>
                        <div class="avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- DASHBOARD PAGE -->
            <section id="dashboardPage" class="page active">
                <!-- FACILITY/SECURITY TABS -->
                <div class="facility-security-tabs">
                    <button class="tab-btn active" data-tab="facility">
                        <i class="fas fa-building"></i> <span data-i18n="facility_tab">FACILITY</span>
                    </button>
                    <button class="tab-btn" data-tab="security">
                        <i class="fas fa-shield-alt"></i> <span data-i18n="security_tab">SECURITY</span>
                    </button>
                </div>
                <!-- FILTRO √öNICO MODERNO -->
                <div id="dashboardFilterContainer"></div>
                <!-- FACILITY TAB CONTENT -->
                <div id="facilityContent" class="tab-content active">
                    <!-- SUMMARY CARDS -->
                    <div class="dashboard-metrics">
                        <div class="card card-metric">
                            <div class="card-header">
                                <h3 data-i18n="total_records">Total de Registros</h3>
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="card-body">
                                <div class="metric-value" id="totalRecords">0</div>
                                <p class="metric-label" data-i18n="incident_records">Incidencias Registradas</p>
                            </div>
                        </div>
                    </div>
                    <!-- CHARTS GRID 2x2 -->
                    <div class="dashboard-charts-grid">
                        <!-- Chart 1: Registros por Fecha (Top Left) -->
                        <div class="card card-chart">
                            <div class="card-header">
                                <h3 data-i18n="records_by_date">Registros por Fecha</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="lineChartDate"></canvas>
                            </div>
                        </div>
                        <!-- Chart 2: Registros por Agente (Top Right) -->
                        <div class="card card-chart">
                            <div class="card-header">
                                <h3 data-i18n="records_by_agent">Registros por Agente</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="barChartAgent"></canvas>
                            </div>
                        </div>
                        <!-- Chart 3: Puntos de Marcaci√≥n (Bottom Left) -->
                        <div class="card card-chart">
                            <div class="card-header">
                                <h3 data-i18n="marking_points">Puntos de Marcaci√≥n</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="pieChartPoints"></canvas>
                            </div>
                        </div>
                        <!-- Chart 4: Ubicaci√≥n de Marcaciones (Bottom Right) -->
                        <div class="card card-map">
                            <div class="card-header">
                                <h3 data-i18n="marking_location">Ubicaci√≥n de Marcaciones</h3>
                            </div>
                            <div class="card-body">
                                <div class="map-container">
                                    <div id="map"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECURITY TAB CONTENT -->
                <div id="securityContent" class="tab-content">
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <h2>Seguridad</h2>
                        <p data-i18n="security_soon">Pr√≥ximamente...</p>
                    </div>
                </div>
            </section>

            <!-- TABLE PAGE -->
            <section id="tablePage" class="page">
                <!-- FACILITY/SECURITY TABS FOR TABLE -->
                <div class="facility-security-tabs">
                    <button class="tab-btn active" data-tab="facility-table">
                        <i class="fas fa-building"></i> <span data-i18n="facility_tab">FACILITY</span>
                    </button>
                    <button class="tab-btn" data-tab="security-table">
                        <i class="fas fa-shield-alt"></i> <span data-i18n="security_tab">SECURITY</span>
                    </button>
                </div>

                <!-- FACILITY TABLE CONTENT -->
                <div id="facilityTableContent" class="tab-content active">
                    <!-- FILTERS -->
                    <div class="card card-filters">
                        <div class="card-header">
                            <h3 data-i18n="filters_title">Filtros</h3>
                        </div>
                        <div class="card-body">
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label data-i18n="from_date">Desde</label>
                                    <input type="date" id="filterFromDate">
                                </div>
                                <div class="filter-group">
                                    <label data-i18n="to_date">Hasta</label>
                                    <input type="date" id="filterToDate">
                                </div>
                                <button id="filterBtn" class="btn-filter">
                                    <i class="fas fa-filter"></i> <span data-i18n="filter_button">Filtrar</span>
                                </button>
                                <button id="resetFilterBtn" class="btn-reset">
                                    <i class="fas fa-redo"></i> <span data-i18n="clear_button">Limpiar</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- EXPORT BUTTONS -->
                    <div class="export-actions">
                        <button id="exportExcelBtn" class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> <span data-i18n="export_excel">Exportar Excel</span>
                        </button>
                        <button id="exportPdfBtn" class="btn-export btn-pdf">
                            <i class="fas fa-file-pdf"></i> <span data-i18n="export_pdf">Exportar PDF</span>
                        </button>
                    </div>

                    <!-- DATA TABLE -->
                    <div class="card card-table">
                        <div class="table-wrapper">
                            <table id="dataTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Nombre</th>
                                        <th>Punto de Marcaci√≥n</th>
                                        <th>Observaci√≥n</th>
                                        <th>Foto</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECURITY TABLE CONTENT -->
                <div id="securityTableContent" class="tab-content">
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <h2>Seguridad</h2>
                        <p>Pr√≥ximamente...</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- IMAGE MODAL -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <img id="modalImage" src="" alt="Foto ampliada">
        </div>
    </div>

    <!-- SCRIPTS -->
    <!-- Orden importante: Languages primero, luego Firebase, luego m√≥dulos, XLSX disponible antes de table.js -->
    <script src="languages.js"></script>
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script src="dashboard.js"></script>
    <script src="app.js"></script>
    <script src="table.js"></script>
    <script src="init.js"></script>
    
    <!-- Debug Script -->
    <script>
        console.log('='.repeat(50));
        console.log('üéØ SCRIPT DE DEBUG');
        console.log('='.repeat(50));
        
        // Monitor Firebase initialization
        setTimeout(() => {
            console.log('\nüìä ESTADO DE FIREBASE:');
            console.log('   firebase:', typeof firebase !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('   window.auth:', window.auth ? '‚úÖ' : '‚ùå');
            console.log('   window.db:', window.db ? '‚úÖ' : '‚ùå');
            console.log('   window.firebaseReady:', window.firebaseReady ? '‚úÖ' : '‚ùå');
            
            console.log('\nüìä ESTADO DEL DOM:');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            console.log('   loginForm:', document.getElementById('loginForm') ? '‚úÖ' : '‚ùå');
            console.log('   email input:', emailInput ? '‚úÖ' : '‚ùå');
            console.log('   password input:', passwordInput ? '‚úÖ' : '‚ùå');
            
            if (emailInput) {
                console.log('   email clickeable:', emailInput.offsetParent !== null ? '‚úÖ' : '‚ùå');
            }
            
            console.log('\nüìä M√ìDULOS CARGADOS:');
            console.log('   authModule:', typeof authModule !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('   dashboardModule:', typeof dashboardModule !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('   tableModule:', typeof tableModule !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('   appModule:', typeof appModule !== 'undefined' ? '‚úÖ' : '‚ùå');
            
            console.log('\n' + '='.repeat(50));
        }, 2000);
    </script>
</body>
</html>
